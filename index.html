<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´«å¾®æ¶æ§‹èˆ‡åäºŒå®®ä½ - å¤©ç›¸4.6 (æŒ‰éˆ•ç¶²æ ¼åŒ–)</title>
    
    <style>
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f7f9fc;
            color: #444;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            width: 95%;
            max-width: 1200px;
        }
        /* æ¨™é¡Œ */
        h1 {
            text-align: center;
            color: #5e548e;
            font-size: 2.2em;
            margin-bottom: 30px;
            font-weight: bold;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }
        h2 {
            font-size: 1.1em;
            color: #6c757d;
            margin: 15px 0 10px;
            font-weight: 600;
        }
        /* ====== ä½ˆå±€å®¹å™¨ (æ ¸å¿ƒï¼šå·¦å³çµæ§‹) ====== */
        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 40px;
            align-items: flex-start;
        }
        /* å·¦å´æ§åˆ¶å€ (Sidebar) */
        .controls {
            flex: 0 0 260px;
            text-align: center;
            border-right: 1px solid #f0f0f0;
            padding-right: 30px;
        }
        /* å³å´å‘½ç›¤å€ */
        .board-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* ====== æŒ‰éˆ•æ¨£å¼ (æŸ”å’Œç‰ˆ) ====== */
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        #mode-switch {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        #mode-switch button {
            background-color: #90a4ae;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            width: 100%;
            letter-spacing: 1px;
        }
        #mode-switch button:hover { background-color: #78909c; }
        #mode-switch button.active {
            background-color: #546e7a;
            font-weight: bold;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        /* ç–ŠåŠ æŒ‰éˆ• */
        #overlay-toggle-btn {
            background-color: #a5d6a7;
            color: #2e5e32;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            transition: all 0.3s;
            font-weight: 600;
        }
        #overlay-toggle-btn:hover { background-color: #81c784; }
        #overlay-toggle-btn.active {
            background-color: #66bb6a;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        /* é¸å–®å®¹å™¨ */
        .selector-group {
            border: 1px solid #f0f0f0;
            background-color: #fafafa;
            padding: 15px 10px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        /* ====== æ–°å¢ï¼šåœ°æ”¯æŒ‰éˆ•ç¶²æ ¼ä½ˆå±€ ====== */
        #ziwei-dz-buttons, #palace-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            justify-content: center;
            align-items: center;
            gap: 4px; /* æŒ‰éˆ•é–“è· */
            padding: 5px;
            /* è®“ä¸­é–“ 2x2 ç•™ç©ºï¼Œä¸¦æŒ‡å®š 12 å®®ä½çš„ grid å€åŸŸ */
            grid-template-areas:
                "p6 p7 p8 p9"
                "p5 . . p10"
                "p4 . . p11"
                "p3 p2 p1 p12";
        }
        /* 12å®®ä½å°æŒ‰éˆ• (èª¿æ•´å¤§å°ä»¥é©æ‡‰4x4ç¶²æ ¼) */
        .palace-btn {
            background-color: #cfd8dc;
            color: #455a64;
            border: none;
            padding: 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
            width: 100%; /* ä½”æ»¿å–®å…ƒæ ¼ */
            height: auto;
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .palace-btn:hover { background-color: #b0bec5; }
        /* é¸ä¸­ç‹€æ…‹ - æŸ”å’Œçš„èµ¤é™¶è‰²/çŠç‘šè‰² */
        .palace-btn.active {
            background-color: #ff8a65;
            color: white;
            font-weight: bold;
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(255, 138, 101, 0.4);
        }

        /* --------------------------------- */
        /* æ ¹æ“šåœ°æ”¯å®šä½æŒ‰éˆ•åˆ°å°æ‡‰çš„ Grid Area */
        /* --------------------------------- */
        #ziwei-dz-buttons button[data-dz="å·³"], #palace-buttons button[data-dz="å·³"] { grid-area: p6; }
        #ziwei-dz-buttons button[data-dz="åˆ"], #palace-buttons button[data-dz="åˆ"] { grid-area: p7; }
        #ziwei-dz-buttons button[data-dz="æœª"], #palace-buttons button[data-dz="æœª"] { grid-area: p8; }
        #ziwei-dz-buttons button[data-dz="ç”³"], #palace-buttons button[data-dz="ç”³"] { grid-area: p9; }
        
        #ziwei-dz-buttons button[data-dz="è¾°"], #palace-buttons button[data-dz="è¾°"] { grid-area: p5; }
        #ziwei-dz-buttons button[data-dz="é…‰"], #palace-buttons button[data-dz="é…‰"] { grid-area: p10; }
        
        #ziwei-dz-buttons button[data-dz="å¯"], #palace-buttons button[data-dz="å¯"] { grid-area: p4; }
        #ziwei-dz-buttons button[data-dz="æˆŒ"], #palace-buttons button[data-dz="æˆŒ"] { grid-area: p11; }

        #ziwei-dz-buttons button[data-dz="å¯…"], #palace-buttons button[data-dz="å¯…"] { grid-area: p3; }
        #ziwei-dz-buttons button[data-dz="ä¸‘"], #palace-buttons button[data-dz="ä¸‘"] { grid-area: p2; }
        #ziwei-dz-buttons button[data-dz="å­"], #palace-buttons button[data-dz="å­"] { grid-area: p1; }
        #ziwei-dz-buttons button[data-dz="äº¥"], #palace-buttons button[data-dz="äº¥"] { grid-area: p12; }
        /* --------------------------------- */

        /* --- ç›¤é¢æ¨£å¼ (ä¿æŒæ¸…æ™°ä½†å¾®èª¿ç·šæ¢) --- */
        .zwdz-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 100%;
            max-width: 700px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
            border: 2px solid #546e7a;
            position: relative;
            background-color: #fff;
        }
        #line-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; grid-area: 1 / 1 / 5 / 5; z-index: 100; }
        .sfz-line {
            position: absolute; background-color: transparent; border: none;
            border-top: 2px dashed rgba(255, 112, 67, 0.5);
            pointer-events: none; transform-origin: 0% 0%;
        }
        .palace {
            border: 1px solid #cfd8dc;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            background-color: #fafdff;
            padding: 5px 5px;
            line-height: 1.2;
            font-size: clamp(0.8rem, 2vw, 1.8em);
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .palace:hover { background-color: #f0f7fa; }
        /* ä¸‰æ–¹å››æ­£ é«˜äº®æ¨£å¼ (æŸ”å’Œç‰ˆ) */
        .palace.san-fang { background-color: #fff3e0; border: 2px solid #ffb74d; }
        .palace.si-zheng { background-color: #e3f2fd; border: 2px solid #64b5f6; }
        /* å®®ä½åç¨±æ¨™ç±¤ */
        .palace-name {
            position: absolute; bottom: 5px; left: 5px;
            font-size: 0.6em; color: #fff;
            font-weight: normal;
            background-color: #7986cb;
            padding: 2px 6px; border-radius: 4px; z-index: 10;
        }
        /* å‘½å®®æ¨™ç±¤æ”¾å¤§ä¸¦æ”¹ç‚ºæ©˜åº• */
        .palace-name.is-minggong {
            font-size: 0.85em; 
            font-weight: bold;
            padding: 3px 8px;
            background-color: #ff8a65; 
        }
        .dz-label { position: absolute; bottom: 5px; right: 5px; font-size: 0.5em; color: #b0bec5; font-weight: normal; }
        
        /* æ˜Ÿæ›œæ–‡å­—é¡è‰² */
        .star-info-container {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            margin-bottom: 2px;
            font-size: 0.75em;
            line-height: 1.1;
        }
        .star-main, .star-assist { font-size: 1.1em; font-weight: bold; line-height: 1.1; color: #7e57c2; }
        .star-assist { color: #8d6e63; }

        /* --- ç¥¿ç¾Šé™€æ–°æ¨£å¼ (ç”¨æ¡†ç·šçªå‡º) --- */
        .star-box {
            /* åŸºç¤æ¨£å¼ï¼šè®“æ˜Ÿæ›œæ–‡å­—åŒ…åœ¨ä¸€å€‹ç›’å­è£¡ */
            padding: 1px 3px; 
            border-radius: 4px;
            margin: 0 2px;
            font-weight: bold;
            display: inline-block;
        }
        /* ç¥¿å­˜ï¼šç¶ è‰²å¯¦å¿ƒæ¡†èˆ‡ç¶ è‰²å­— */
        .star-box.luchun {
            color: #4CAF55; /* ç¶ è‰²å­— */
            border: 2px solid #4CAF55; /* ç¶ è‰²å¯¦ç·šæ¡† */
        }
        /* ç¾Šé™€ï¼šç´…è‰²ç©ºå¿ƒæ¡†èˆ‡ç´…è‰²å­— */
        .star-box.yangtuo {
            color: #D32F2F; /* ç´…è‰²å­— */
            border: 2px solid #D32F2F; /* ç´…è‰²å¯¦ç·šæ¡† */
        }
        
        /* --- å››åŒ–æ¨™ç±¤æ¨£å¼ --- */
        .si-hua {
            font-size: 1.1em; 
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 5px;
            vertical-align: middle;
            line-height: 1.1;
            display: inline-block;
            color: white !important;
        }
        /* åŒ–å¿Œï¼šç´…åº•ç™½å­— */
        .si-hua.huaji { background-color: #D32F2F; }     
        /* åŒ–ç¥¿, åŒ–æ¬Š, åŒ–ç§‘ï¼šç¶ åº•ç™½å­— */
        .si-hua.hualu, .si-hua.huaquan, .si-hua.huake { background-color: #4CAF55; } 

        /* å®šä½ */
        #p1  { grid-area: 4 / 3 / 5 / 4; } #p2  { grid-area: 4 / 2 / 5 / 3; } #p3  { grid-area: 4 / 1 / 5 / 2; }
        #p4  { grid-area: 3 / 1 / 4 / 2; } #p5  { grid-area: 2 / 1 / 3 / 2; } #p6  { grid-area: 1 / 1 / 2 / 2; }
        #p7  { grid-area: 1 / 2 / 2 / 3; } #p8  { grid-area: 1 / 3 / 2 / 4; } #p9  { grid-area: 1 / 4 / 2 / 5; }
        #p10 { grid-area: 2 / 4 / 3 / 5; } #p11 { grid-area: 3 / 4 / 4 / 5; } #p12 { grid-area: 4 / 4 / 5 / 5; }
        /* ä¸­é–“æ¨™é¡Œ */
        #center-title {
            grid-area: 2 / 2 / 4 / 4;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5em; color: #5e548e;
            font-weight: bold; text-align: center; line-height: 1.5; z-index: 50;
        }
        /* ====== æ‰‹æ©Ÿ/å¹³æ¿å„ªåŒ– (ç•¶è¢å¹•è®Šçª„æ™‚ï¼Œä½ˆå±€æ”¹ç‚ºå‚ç›´å †ç–Š) ====== */
        @media (max-width: 900px) {
            .main-layout { flex-direction: column; gap: 20px; }
            .controls {
                width: 100%; flex: none; border-right: none;
                border-bottom: 1px solid #f0f0f0;
                padding-right: 0; padding-bottom: 20px; margin-bottom: 20px;
            }
            #mode-switch { flex-direction: row; justify-content: center; }
            .zwdz-board { width: 100%; max-width: 500px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç´«å¾®æ–—æ•¸ çµæ§‹æ•™å­¸ (å¤©ç›¸4.6)</h1>

        <div class="main-layout">
            <div class="controls">
                <div id="mode-switch">
                    <button id="star-mode-btn" class="active">æ˜Ÿæ›œæ¶æ§‹</button>
                    <button id="palace-mode-btn">åäºŒå®®ä½</button>
                </div>

                <div id="tiangan-selector" class="selector-group">
                    <h2>æµå¹´å¤©å¹² (å››åŒ–èˆ‡ç¥¿ç¾Šé™€)</h2>
                    <select id="tiangan-select">
                        <option value="">ä¸é¡¯ç¤ºå››åŒ–/ç¥¿ç¾Šé™€</option>
                        <option value="ç”²">ç”²å¹´</option>
                        <option value="ä¹™">ä¹™å¹´</option>
                        <option value="ä¸™">ä¸™å¹´</option>
                        <option value="ä¸">ä¸å¹´</option>
                        <option value="æˆŠ">æˆŠå¹´</option>
                        <option value="å·±">å·±å¹´</option>
                        <option value="åºš">åºšå¹´</option>
                        <option value="è¾›">è¾›å¹´</option>
                        <option value="å£¬">å£¬å¹´</option>
                        <option value="ç™¸">ç™¸å¹´</option>
                    </select>
                </div>

                <div id="star-selector" class="selector-group">
                    <h2>ç´«å¾®æ˜Ÿ è½å®®</h2>
                    <div id="ziwei-dz-buttons"></div>
                </div>

                <div id="palace-overlay-control">
                    <button id="overlay-toggle-btn">é¡¯ç¤ºå‘½å®®é«”ç³»</button>
                </div>

                <div id="palace-selector" class="selector-group" style="display:none;">
                    <h2>å‘½å®® æ‰€åœ¨å®®ä½</h2>
                    <div id="palace-buttons"></div>
                </div>
            </div>

            <div class="board-area">
                <div class="zwdz-board">
                    <div class="palace" id="p1" data-dz="å­"></div>
                    <div class="palace" id="p2" data-dz="ä¸‘"></div>
                    <div class="palace" id="p3" data-dz="å¯…"></div>
                    <div class="palace" id="p4" data-dz="å¯"></div>
                    <div class="palace" id="p5" data-dz="è¾°"></div>
                    <div class="palace" id="p6" data-dz="å·³"></div>
                    <div class="palace" id="p7" data-dz="åˆ"></div>
                    <div class="palace" id="p8" data-dz="æœª"></div>
                    <div class="palace" id="p9" data-dz="ç”³"></div>
                    <div class="palace" id="p10" data-dz="é…‰"></div>
                    <div class="palace" id="p11" data-dz="æˆŒ"></div>
                    <div class="palace" id="p12" data-dz="äº¥"></div>

                    <div id="line-overlay"></div>

                    <div id="center-title">
                        **æ˜Ÿæ›œæ¶æ§‹**
                    </div>
                </div>

                <p style="text-align: center; margin-top: 15px; font-size: 1.1em; color: #90a4ae;">
                    ğŸ’¡ <strong style="color: #7986cb;">é»æ“Šå®®ä½</strong>å¯é¡¯ç¤ºä¸‰æ–¹å››æ­£
                </p>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒæ˜Ÿæ›œæ•¸æ“šçµæ§‹ (ä¿æŒä¸è®Š)
        const starPlacement = [
            { name: 'ç´«å¾®', delta: 0, group: 'Z', color: 'star-main', desc: 'å¸åº§ï¼Œé ˜å°' },
            { name: 'å¤©æ©Ÿ', delta: 11, group: 'Z', color: 'star-main', desc: 'æ™ºæ…§' },
            { name: 'å¤ªé™½', delta: 9, group: 'Z', color: 'star-main', desc: 'å®˜ç¥¿' },
            { name: 'æ­¦æ›²', delta: 8, group: 'Z', color: 'star-main', desc: 'è²¡æ˜Ÿ' },
            { name: 'å¤©åŒ', delta: 7, group: 'Z', color: 'star-main', desc: 'ç¦æ˜Ÿ' },
            { name: 'å»‰è²', delta: 4, group: 'Z', color: 'star-main', desc: 'å›šæ˜Ÿ' },
            { name: 'å¤©åºœ', tfOffset: 0, group: 'F', color: 'star-assist', desc: 'è²¡åº«' },
            { name: 'å¤ªé™°', tfOffset: 1, group: 'F', color: 'star-assist', desc: 'æŸ”ç¾' },
            { name: 'è²ªç‹¼', tfOffset: 2, group: 'F', color: 'star-assist', desc: 'æ…¾æœ›' },
            { name: 'å·¨é–€', tfOffset: 3, group: 'F', color: 'star-assist', desc: 'æ˜¯é' },
            { name: 'å¤©ç›¸', tfOffset: 4, group: 'F', color: 'star-assist', desc: 'æœå‹™' },
            { name: 'å¤©æ¢', tfOffset: 5, group: 'F', color: 'star-assist', desc: 'è”­æ˜Ÿ' },
            { name: 'ä¸ƒæ®º', tfOffset: 6, group: 'F', color: 'star-assist', desc: 'é–‹å‰µ' },
            { name: 'ç ´è»', tfOffset: 10, group: 'F', color: 'star-assist', desc: 'è®ŠåŒ–' },
            { name: 'æ–‡æ˜Œ', fixedDz: null, group: 'Aux', color: 'star-assist', desc: 'ç§‘ç”²' },
            { name: 'æ–‡æ›²', fixedDz: null, group: 'Aux', color: 'star-assist', desc: 'è—æ–‡' },
            { name: 'å³å¼¼', fixedDz: null, group: 'Aux', color: 'star-assist', desc: 'è¼”ä½' }
        ];

        // å››åŒ–è¡¨æ•¸æ“š
        const siHuaTable = {
            'ç”²': { 'å»‰è²': 'ç¥¿', 'ç ´è»': 'æ¬Š', 'æ–‡æ›²': 'ç§‘', 'å¤ªé™½': 'å¿Œ' },
            'ä¹™': { 'å¤©æ©Ÿ': 'ç¥¿', 'å¤©æ¢': 'æ¬Š', 'ç´«å¾®': 'ç§‘', 'å¤ªé™°': 'å¿Œ' },
            'ä¸™': { 'å¤©åŒ': 'ç¥¿', 'å¤©æ©Ÿ': 'æ¬Š', 'æ–‡æ˜Œ': 'ç§‘', 'å»‰è²': 'å¿Œ' },
            'ä¸': { 'å¤ªé™°': 'ç¥¿', 'å¤©åŒ': 'æ¬Š', 'å¤©æ©Ÿ': 'ç§‘', 'å·¨é–€': 'å¿Œ' },
            'æˆŠ': { 'è²ªç‹¼': 'ç¥¿', 'å¤ªé™°': 'æ¬Š', 'å³å¼¼': 'ç§‘', 'å¤©æ©Ÿ': 'å¿Œ' },
            'å·±': { 'æ­¦æ›²': 'ç¥¿', 'è²ªç‹¼': 'æ¬Š', 'å¤©æ¢': 'ç§‘', 'æ–‡æ›²': 'å¿Œ' },
            'åºš': { 'å¤ªé™½': 'ç¥¿', 'æ­¦æ›²': 'æ¬Š', 'å¤©åŒ': 'ç§‘', 'å¤©ç›¸': 'å¿Œ' }, 
            'è¾›': { 'å·¨é–€': 'ç¥¿', 'å¤ªé™½': 'æ¬Š', 'æ–‡æ˜Œ': 'ç§‘', 'æ–‡æ›²': 'å¿Œ' },
            'å£¬': { 'å¤©æ¢': 'ç¥¿', 'ç´«å¾®': 'æ¬Š', 'å¤©åºœ': 'ç§‘', 'æ­¦æ›²': 'å¿Œ' },
            'ç™¸': { 'ç ´è»': 'ç¥¿', 'å·¨é–€': 'æ¬Š', 'å¤ªé™°': 'ç§‘', 'è²ªç‹¼': 'å¿Œ' }
        };

        // ç¥¿ç¾Šé™€æ’åˆ—è¡¨
        const luYangTuoTable = {
            'ç”²': ['å¯…', 'å¯', 'ä¸‘'], 'ä¹™': ['å¯', 'è¾°', 'å¯…'], 'ä¸™': ['å·³', 'åˆ', 'è¾°'],
            'ä¸': ['åˆ', 'æœª', 'å·³'], 'æˆŠ': ['å·³', 'åˆ', 'è¾°'], 'å·±': ['åˆ', 'æœª', 'å·³'],
            'åºš': ['ç”³', 'é…‰', 'æœª'], 'è¾›': ['é…‰', 'æˆŒ', 'ç”³'], 'å£¬': ['äº¥', 'å­', 'æˆŒ'],
            'ç™¸': ['å­', 'ä¸‘', 'äº¥']
        };

        document.addEventListener('DOMContentLoaded', () => {
            const ziweiDzButtonsContainer = document.getElementById('ziwei-dz-buttons');
            const palaceButtonsContainer = document.getElementById('palace-buttons');
            const tianganSelect = document.getElementById('tiangan-select');
            const palaceElements = [
                document.getElementById('p1'), document.getElementById('p2'), document.getElementById('p3'),
                document.getElementById('p4'), document.getElementById('p5'), document.getElementById('p6'),
                document.getElementById('p7'), document.getElementById('p8'), document.getElementById('p9'),
                document.getElementById('p10'), document.getElementById('p11'), document.getElementById('p12')
            ];
            const lineOverlay = document.getElementById('line-overlay');
            const starModeBtn = document.getElementById('star-mode-btn');
            const palaceModeBtn = document.getElementById('palace-mode-btn');
            const starSelector = document.getElementById('star-selector');
            const palaceSelector = document.getElementById('palace-selector');
            const overlayControl = document.getElementById('palace-overlay-control');
            const overlayToggleBtn = document.getElementById('overlay-toggle-btn');
            const centerTitle = document.getElementById('center-title');

            let currentMode = 'star';
            let activeZiWeiDz = 'å­';
            let activeMingGongDz = 'å­';
            let showPalaceOverlay = false;
            let activeSanFangSiZhengDz = null;
            let activeTianGan = '';

            // 12 åœ°æ”¯å®®ä½åˆ—è¡¨ (ç”¨æ–¼æŒ‰éˆ•å‰µå»º)
            const dzMap = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            const dzToIdx = dzMap.reduce((acc, dz, index) => { acc[dz] = index; return acc; }, {});
            const palaceOrder = ['å‘½', 'å…„', 'å¤«', 'å­', 'è²¡', 'ç–¾', 'é·', 'åƒ•', 'å®˜', 'ç”°', 'ç¦', 'çˆ¶'];

            // å®®ä½ä¸­å¿ƒé»åº§æ¨™ (ä¿æŒä¸è®Š)
            const palaceCenters = {
                'p1': { x: 62.5, y: 87.5 }, 'p2': { x: 37.5, y: 87.5 }, 'p3': { x: 12.5, y: 87.5 },
                'p4': { x: 12.5, y: 62.5 }, 'p5': { x: 12.5, y: 37.5 }, 'p6': { x: 12.5, y: 12.5 },
                'p7': { x: 37.5, y: 12.5 }, 'p8': { x: 62.5, y: 12.5 }, 'p9': { x: 87.5, y: 12.5 },
                'p10': { x: 87.5, y: 37.5 }, 'p11': { x: 87.5, y: 62.5 }, 'p12': { x: 87.5, y: 87.5 }
            };
            const HALF_PALACE_SIZE = 12.5;
            const LINE_OVERLAP_FACTOR = 1.0;

            function drawLine(p1Id, p2Id, container) {
                const c1 = palaceCenters[p1Id]; const c2 = palaceCenters[p2Id];
                const dx = c2.x - c1.x; const dy = c2.y - c1.y;
                const totalLength = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                const ux = dx / totalLength; const uy = dy / totalLength;
                const startX = c1.x + ux * (HALF_PALACE_SIZE * LINE_OVERLAP_FACTOR);
                const startY = c1.y + uy * (HALF_PALACE_SIZE * LINE_OVERLAP_FACTOR);
                const newLength = totalLength - (2 * HALF_PALACE_SIZE * LINE_OVERLAP_FACTOR);
                if (newLength <= 0) return;
                const line = document.createElement('div');
                line.classList.add('sfz-line');
                line.style.width = `${newLength}%`;
                line.style.left = `${startX}%`;
                line.style.top = `${startY}%`;
                line.style.transform = `rotate(${angle}deg)`;
                container.appendChild(line);
            }

            function drawSFZLines(dz, container) {
                if (!dz) return;
                const selectedIdx = dzToIdx[dz];
                const indices = [selectedIdx, (selectedIdx + 4) % 12, (selectedIdx - 4 + 12) % 12, (selectedIdx + 6) % 12];
                const ids = indices.map(idx => 'p' + (idx + 1));
                drawLine(ids[0], ids[1], container); drawLine(ids[1], ids[2], container);
                drawLine(ids[2], ids[0], container); drawLine(ids[0], ids[3], container);
            }

            function calculateStarLayout(ziWeiDz, activeTianGan) {
                const layout = {};
                const ziWeiIdx = dzToIdx[ziWeiDz];
                const tianFuIdx = (4 - ziWeiIdx + 12) % 12;

                // 1. æ”¾ç½®ä¸»æ˜Ÿå’Œè¼”æ˜Ÿ
                const mainAndSiHuaStars = starPlacement.filter(star => star.group === 'Z' || star.group === 'F');
                
                mainAndSiHuaStars.forEach((star) => {
                    let targetIdx;
                    if (star.group === 'Z') { targetIdx = (ziWeiIdx + star.delta) % 12; }
                    else if (star.group === 'F') { targetIdx = (tianFuIdx + star.tfOffset) % 12; }
                    const palaceId = 'p' + (targetIdx + 1);

                    if (!layout[palaceId]) { layout[palaceId] = []; }
                    const starHTML = `<div class="star-info-container"><span class="${star.color}" data-star="${star.name}" title="${star.desc}">${star.name}</span></div>`;
                    layout[palaceId].push({ name: star.name, html: starHTML, isMain: star.group === 'Z', type: 'Main' });
                });

                // 2. æ”¾ç½®ç¥¿ç¾Šé™€
                if (activeTianGan && luYangTuoTable[activeTianGan]) {
                    const [luDz, yangDz, tuoDz] = luYangTuoTable[activeTianGan];
                    
                    const luPalaceId = 'p' + (dzToIdx[luDz] + 1);
                    const yangPalaceId = 'p' + (dzToIdx[yangDz] + 1);
                    const tuoPalaceId = 'p' + (dzToIdx[tuoDz] + 1);

                    const luHTML = `<div class="star-info-container"><span class="star-box luchun" data-star="ç¥¿å­˜">ç¥¿å­˜</span></div>`;
                    const yangHTML = `<div class="star-info-container"><span class="star-box yangtuo" data-star="æ“ç¾Š">æ“ç¾Š</span></div>`;
                    const tuoHTML = `<div class="star-info-container"><span class="star-box yangtuo" data-star="é™€ç¾…">é™€ç¾…</span></div>`;

                    if (!layout[luPalaceId]) { layout[luPalaceId] = []; }
                    layout[luPalaceId].push({ name: 'ç¥¿å­˜', html: luHTML, isMain: false, type: 'Aux' });
                    
                    if (!layout[yangPalaceId]) { layout[yangPalaceId] = []; }
                    layout[yangPalaceId].push({ name: 'æ“ç¾Š', html: yangHTML, isMain: false, type: 'Aux' });

                    if (!layout[tuoPalaceId]) { layout[tuoPalaceId] = []; }
                    layout[tuoPalaceId].push({ name: 'é™€ç¾…', html: tuoHTML, isMain: false, type: 'Aux' });
                }

                return layout;
            }

            function calculatePalaceLayout(mingGongDz) {
                const layout = {};
                const mingGongIdx = dzToIdx[mingGongDz];
                palaceOrder.forEach((palaceName, offset) => {
                    const targetIdx = (mingGongIdx - offset + 12) % 12;
                    const palaceId = 'p' + (targetIdx + 1);
                    
                    const mingGongClass = (palaceName === 'å‘½') ? ' is-minggong' : '';

                    layout[palaceId] = `<span class="palace-name${mingGongClass}">${palaceName}</span>`;
                });
                return layout;
            }

            function renderLayout() {
                lineOverlay.innerHTML = '';
                palaceElements.forEach(palace => {
                    const dz = palace.getAttribute('data-dz');
                    palace.innerHTML = `<span class="dz-label">${dz}</span>`; 
                    palace.classList.remove('san-fang', 'si-zheng');
                });

                if (activeSanFangSiZhengDz) {
                    drawSFZLines(activeSanFangSiZhengDz, lineOverlay);
                    const selectedIdx = dzToIdx[activeSanFangSiZhengDz];
                    const sanFangIndices = [selectedIdx, (selectedIdx + 4) % 12, (selectedIdx - 4 + 12) % 12];
                    const siZhengIndex = (selectedIdx + 6) % 12;
                    sanFangIndices.forEach(idx => { document.getElementById('p' + (idx + 1)).classList.add('san-fang'); });
                    document.getElementById('p' + (siZhengIndex + 1)).classList.add('si-zheng');
                }

                const currentSiHua = activeTianGan ? siHuaTable[activeTianGan] : {};
                const starLayout = calculateStarLayout(activeZiWeiDz, activeTianGan);

                if (currentMode === 'star') {
                    for (const id in starLayout) {
                        const palace = document.getElementById(id);
                        if (palace) {
                            const starHtmlWithSiHua = starLayout[id].map(starObj => {
                                let starHTML = starObj.html;
                                
                                // åƒ…å°ä¸»æ˜Ÿ/è¼”æ˜Ÿæ¨™è¨»å››åŒ–
                                if (starObj.type === 'Main' && currentSiHua[starObj.name]) {
                                    const huaType = currentSiHua[starObj.name]; 
                                    let huaClass = '';
                                    if (huaType === 'ç¥¿') { huaClass = 'hualu'; }
                                    else if (huaType === 'æ¬Š') { huaClass = 'huaquan'; }
                                    else if (huaType === 'ç§‘') { huaClass = 'huake'; }
                                    else if (huaType === 'å¿Œ') { huaClass = 'huaji'; }

                                    const siHuaTag = `<span class="si-hua ${huaClass}">${huaType}</span>`;
                                    starHTML = starHTML.replace(`</span></div>`, `</span>${siHuaTag}</div>`);
                                }
                                
                                return starHTML;
                            }).join('');

                            palace.innerHTML = starHtmlWithSiHua + palace.innerHTML; 
                        }
                    }

                    if (showPalaceOverlay) {
                        const palaceLayout = calculatePalaceLayout(activeMingGongDz);
                        for (const id in palaceLayout) {
                            const palace = document.getElementById(id);
                            if (palace) { 
                                palace.innerHTML += palaceLayout[id]; 
                            }
                        }
                    }

                    const overlayText = showPalaceOverlay ? ` (å‘½å®®åœ¨ ${activeMingGongDz})` : '';
                    const tianganText = activeTianGan ? ` / **${activeTianGan}** å¹´å››åŒ–/ç¥¿ç¾Šé™€` : '';
                    centerTitle.innerHTML = `ç´«å¾®åœ¨ **${activeZiWeiDz}** å®®${overlayText}${tianganText}`;

                    document.querySelectorAll('#ziwei-dz-buttons .palace-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`#ziwei-dz-buttons .palace-btn[data-dz="${activeZiWeiDz}"]`).classList.add('active');
                    document.querySelectorAll('#palace-buttons .palace-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`#palace-buttons .palace-btn[data-dz="${activeMingGongDz}"]`).classList.add('active');

                } else {
                    const palaceLayout = calculatePalaceLayout(activeMingGongDz);
                    for (const id in palaceLayout) {
                        const palace = document.getElementById(id);
                        if (palace) { 
                            palace.innerHTML = palaceLayout[id] + palace.innerHTML; 
                        }
                    }
                    centerTitle.innerHTML = `å‘½å®®åœ¨ **${activeMingGongDz}** å®®<br>åäºŒå®®ä½æ¶æ§‹`;
                    document.querySelectorAll('#palace-buttons .palace-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`#palace-buttons .palace-btn[data-dz="${activeMingGongDz}"]`).classList.add('active');
                }
            }

            function switchMode(mode) {
                currentMode = mode;
                if (mode === 'star') {
                    starModeBtn.classList.add('active');
                    palaceModeBtn.classList.remove('active');
                    starSelector.style.display = 'block';
                    palaceSelector.style.display = 'block';
                    overlayControl.style.display = 'block';
                    tianganSelect.parentNode.style.display = 'block';
                } else {
                    starModeBtn.classList.remove('active');
                    palaceModeBtn.classList.add('active');
                    starSelector.style.display = 'none';
                    palaceSelector.style.display = 'block';
                    overlayControl.style.display = 'none';
                    showPalaceOverlay = false;
                    overlayToggleBtn.classList.remove('active');
                    tianganSelect.parentNode.style.display = 'none';
                }
                renderLayout();
            }

            // åˆå§‹åŒ–æŒ‰éˆ•
            dzMap.forEach(dz => {
                const starButton = document.createElement('button');
                starButton.textContent = dz;
                starButton.classList.add('palace-btn');
                starButton.setAttribute('data-dz', dz);
                starButton.addEventListener('click', function() { activeZiWeiDz = dz; renderLayout(); });
                ziweiDzButtonsContainer.appendChild(starButton);
                const palaceButton = document.createElement('button');
                palaceButton.textContent = dz;
                palaceButton.classList.add('palace-btn');
                palaceButton.setAttribute('data-dz', dz);
                palaceButton.addEventListener('click', function() { activeMingGongDz = dz; renderLayout(); });
                palaceButtonsContainer.appendChild(palaceButton);
            });

            // ç–ŠåŠ æŒ‰éˆ•äº‹ä»¶
            overlayToggleBtn.addEventListener('click', function() {
                showPalaceOverlay = !showPalaceOverlay;
                overlayToggleBtn.classList.toggle('active', showPalaceOverlay);
                renderLayout();
            });

            // æ¨¡å¼åˆ‡æ›äº‹ä»¶
            starModeBtn.addEventListener('click', () => switchMode('star'));
            palaceModeBtn.addEventListener('click', () => switchMode('palace'));

            // å¤©å¹²é¸æ“‡å™¨äº‹ä»¶ç›£è½
            tianganSelect.addEventListener('change', function() {
                activeTianGan = this.value;
                renderLayout();
            });

            // å®®ä½é»æ“Šäº‹ä»¶ (ä¸‰æ–¹å››æ­£)
            palaceElements.forEach(palace => {
                palace.addEventListener('click', function() {
                    const clickedDz = palace.getAttribute('data-dz');
                    activeSanFangSiZhengDz = (activeSanFangSiZhengDz === clickedDz) ? null : clickedDz;
                    renderLayout();
                });
            });

            switchMode('star');
        });
    </script>
</body>
</html>